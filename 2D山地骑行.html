<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>2D山地骑行游戏</title>
<style>
body { margin:0; overflow:hidden; background:#87ceeb; touch-action:none; }
#score { position:absolute; top:10px; left:10px; font-size:20px; font-family:Arial, sans-serif; color:#fff; z-index:10;}
.controls { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); z-index:10;}
button { font-size:16px; padding:8px 12px; margin:5px; }
canvas { display:block; }
</style>
</head>
<body>
<div id="score">分数: 0</div>
<div class="controls">
  <button onclick="restartGame()">重新开始</button>
  <button onclick="exitGame()">退出游戏</button>
</div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let car = {x: canvas.width/2, y: canvas.height-100, width:40, height:20};
let keys = {left:false, right:false};
let obstacles = [];
let scroll = 0;
let score = 0;
let gameOver = false;
let touchStartX = 0;

// 监听键盘
document.addEventListener('keydown', e=>{
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=true;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=true;
});
document.addEventListener('keyup', e=>{
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=false;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=false;
});

// 手机触屏
canvas.addEventListener('touchstart', e=>{
  touchStartX = e.touches[0].clientX;
});
canvas.addEventListener('touchmove', e=>{
  const dx = e.touches[0].clientX - touchStartX;
  car.x += dx*0.1;
  if(car.x<20) car.x=20;
  if(car.x>canvas.width-20) car.x=canvas.width-20;
  touchStartX = e.touches[0].clientX;
},{passive:false});

// 生成障碍物
function createObstacle(){
  const x = Math.random()*(canvas.width-40)+20;
  obstacles.push({x:x, y:-20, width:30, height:20});
}

// 重新开始
function restartGame(){
  if(confirm("是否重新开始游戏？")){
    obstacles=[];
    car.x=canvas.width/2;
    score=0;
    scroll=0;
    gameOver=false;
    document.getElementById('score').innerText = "分数: 0";
  }
}

// 退出游戏
function exitGame(){
  if(confirm("是否确认退出游戏？")){
    gameOver = true;
    alert("游戏已退出，页面将关闭！");
    window.close(); // 有些浏览器不允许直接关闭
    // 如果关闭失败，刷新页面作为替代
    setTimeout(()=>{ location.reload(); }, 200);
  }
}

// 更新游戏状态
function update(){
  if(gameOver) return;
  if(keys.left) car.x -= 5;
  if(keys.right) car.x +=5;
  if(car.x<20) car.x=20;
  if(car.x>canvas.width-20) car.x=canvas.width-20;

  scroll += 5;
  if(scroll%60===0) createObstacle();
  score = Math.floor(scroll/5);
  document.getElementById('score').innerText = "分数: "+score;

  // 移动障碍物
  for(let i=0;i<obstacles.length;i++){
    obstacles[i].y +=5;
    // 碰撞检测
    if(obstacles[i].y+obstacles[i].height>car.y &&
       obstacles[i].y<car.y+car.height &&
       obstacles[i].x+obstacles[i].width>car.x-car.width/2 &&
       obstacles[i].x<car.x+car.width/2){
      gameOver = true;
      alert("游戏结束! 得分: "+score);
    }
  }
  // 删除超出屏幕的障碍
  obstacles = obstacles.filter(o=>o.y<canvas.height+20);
}

// 绘制山路
function drawRoad(){
  ctx.fillStyle="#654321";
  ctx.beginPath();
  ctx.moveTo(0, canvas.height);
  for(let i=0;i<canvas.width;i+=10){
    const y = canvas.height/2 + Math.sin((i+scroll*0.5)/50)*50;
    ctx.lineTo(i, y);
  }
  ctx.lineTo(canvas.width, canvas.height);
  ctx.closePath();
  ctx.fill();
}

// 绘制游戏
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawRoad();

  // 绘制玩家
  ctx.fillStyle="green";
  ctx.fillRect(car.x-car.width/2, car.y, car.width, car.height);

  // 绘制障碍物
  ctx.fillStyle="red";
  for(let o of obstacles){
    ctx.fillRect(o.x, o.y, o.width, o.height);
  }
}

// 游戏循环
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>